<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Styling for dynamic elements */
        .profile-item, .transaction-item {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .profile-item:hover {
            background-color: #f0f9ff; /* light blue hover */
            border-left-color: #7dd3fc; /* sky-300 */
        }
        .profile-item.active {
            background-color: #e0f2fe; /* sky-100 */
            border-left-width: 4px;
            border-left-color: #0ea5e9; /* sky-500 */
            font-weight: 500;
        }
         .profile-item.active .profile-name {
            color: #0284c7; /* sky-600 */
        }
        .transaction-item:hover {
            background-color: #f8fafc; /* slate-50 */
        }
        /* Icons alignment */
        .icon-text-align {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center; /* For vertical centering */
            justify-content: center; /* For horizontal centering */
        }
        .modal-content {
            background-color: #fefefe;
            /* margin: 10% auto; Removed for flex centering */
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: modalOpen 0.3s ease-out;
        }
        @keyframes modalOpen {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-close-btn {
            transition: transform 0.2s ease-in-out, background-color 0.2s;
        }
        .modal-close-btn:hover {
            transform: rotate(90deg);
            background-color: #e2e8f0; /* slate-200 */
        }
        /* Custom focus rings for better visibility */
        input:focus, select:focus, button:focus-visible {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px theme('colors.sky.500');
        }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased">
    <div class="flex flex-col md:flex-row min-h-screen">
        <aside class="w-full md:w-72 bg-white shadow-lg p-6 space-y-6 flex flex-col">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-sky-600">MoneyTrack</h1>
                </div>

            <div class="flex-grow">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-slate-700">Profiles</h2>
                    <button id="addProfileBtn" title="Add New Profile" class="p-2 rounded-md hover:bg-sky-100 text-sky-600 active:bg-sky-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                    </button>
                </div>
                <div id="profilesList" class="space-y-1.5 max-h-60 md:max-h-80 overflow-y-auto pr-1">
                    </div>
                <button id="viewAllProfilesBtn" class="mt-4 w-full flex items-center justify-center gap-2 text-sm py-2.5 px-4 rounded-lg bg-sky-500 text-white hover:bg-sky-600 active:bg-sky-700 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    View All Profiles
                </button>
            </div>

            <div class="space-y-4 pt-4 border-t border-slate-200">
                <div>
                    <h2 class="text-md font-semibold text-slate-700 mb-2">App Settings</h2>
                    <label for="currencySelect" class="block text-xs font-medium text-slate-600 mb-1">Default New Profile Currency:</label>
                    <select id="currencySelect" name="currency" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 text-sm">
                        <option value="IDR">IDR - Indonesian Rupiah</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="SGD">SGD - Singapore Dollar</option>
                    </select>
                </div>

                <div class="space-y-2">
                     <h2 class="text-md font-semibold text-slate-700 mb-2">Data Management</h2>
                    <button id="importDataBtn" class="w-full flex items-center justify-center gap-2 text-sm py-2 px-4 rounded-lg bg-slate-600 text-white hover:bg-slate-700 active:bg-slate-800 transition-colors shadow-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        Import Data
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                    <button id="exportDataBtn" class="w-full flex items-center justify-center gap-2 text-sm py-2 px-4 rounded-lg bg-slate-600 text-white hover:bg-slate-700 active:bg-slate-800 transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Export Data
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-6 md:p-8 bg-slate-50">
            <header class="mb-6">
                <h2 id="currentProfileName" class="text-3xl font-bold text-slate-800">Dashboard</h2>
                <p id="profileCurrencyDisplay" class="text-sm text-slate-500">Select a profile or view all.</p>
            </header>

            <section id="summarySection" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold text-green-600 mb-2 icon-text-align">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        Total Income
                    </h3>
                    <p id="totalIncome" class="text-3xl font-bold text-slate-700">Rp0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold text-red-600 mb-2 icon-text-align">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m12 16-4-4 4-4"/><path d="M12 8v8"/></svg>
                        Total Outcome
                    </h3>
                    <p id="totalOutcome" class="text-3xl font-bold text-slate-700">Rp0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold text-sky-600 mb-2 icon-text-align">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-landmark"><line x1="12" x2="12" y1="22" y2="18"/><path d="M5 22V10l7-7 7 7v12"/><path d="M13 13h-2v8h2v-8Z"/><path d="M4 22h16"/><path d="m22 10-5 5V7l-5-5-5 5v3l-5-5Z"/></svg>
                        Net Balance
                    </h3>
                    <p id="netBalance" class="text-3xl font-bold text-slate-700">Rp0</p>
                </div>
            </section>

            <section class="mb-8 flex flex-col sm:flex-row gap-4">
                <button id="addIncomeBtn" class="flex-1 icon-text-align justify-center py-3 px-6 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 active:bg-green-700 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                    Add Income
                </button>
                <button id="addOutcomeBtn" class="flex-1 icon-text-align justify-center py-3 px-6 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 active:bg-red-700 transition-colors shadow-sm">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-minus"><line x1="5" x2="19" y1="12" y2="12"/></svg>
                    Add Outcome
                </button>
            </section>

            <section id="transactionsSection">
                <h3 class="text-2xl font-semibold text-slate-700 mb-4">Recent Transactions</h3>
                <div id="transactionsListContainer" class="bg-white p-2 rounded-xl shadow">
                    <div id="transactionsList" class="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">
                        <div class="transaction-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-4">
                            <div class="mb-2 sm:mb-0">
                                <p class="font-medium text-slate-800">Example: Salary</p>
                                <p class="text-xs text-slate-500">2025-05-10, 09:00 AM - Income</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-semibold text-green-600 text-lg">Rp10,000,000</span>
                                <div class="flex gap-2">
                                    <button class="p-1.5 text-sky-600 hover:text-sky-700 rounded-md hover:bg-sky-100" title="Edit Transaction">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" x2="22" y1="2" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                    </button>
                                    <button class="p-1.5 text-red-500 hover:text-red-700 rounded-md hover:bg-red-100" title="Delete Transaction">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="noTransactionsMessage" class="p-4 text-center text-slate-500 hidden">No transactions yet for this profile.</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="profileModalTitle" class="text-xl font-semibold text-slate-700">Add New Profile</h3>
                <button id="closeProfileModalBtn" title="Close" class="p-1.5 rounded-full hover:bg-slate-200 text-slate-500 modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <form id="profileForm">
                <input type="hidden" id="profileIdInput"> <div class="mb-4">
                    <label for="profileNameInput" class="block text-sm font-medium text-slate-600 mb-1">Profile Name</label>
                    <input type="text" id="profileNameInput" name="profileName" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-6">
                    <label for="profileCurrencyInput" class="block text-sm font-medium text-slate-600 mb-1">Default Currency</label>
                    <select id="profileCurrencyInput" name="profileCurrency" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        <option value="IDR">IDR - Indonesian Rupiah</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="SGD">SGD - Singapore Dollar</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelProfileBtn" class="py-2 px-4 rounded-md text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors">Cancel</button>
                    <button type="submit" id="saveProfileBtn" class="py-2 px-4 rounded-md bg-sky-500 text-white hover:bg-sky-600 active:bg-sky-700 transition-colors">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="transactionModalTitle" class="text-xl font-semibold text-slate-700">Add New Transaction</h3>
                 <button id="closeTransactionModalBtn" title="Close" class="p-1.5 rounded-full hover:bg-slate-200 text-slate-500 modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionIdInput"> <input type="hidden" id="transactionTypeInput"> <div class="mb-4">
                    <label for="transactionDescriptionInput" class="block text-sm font-medium text-slate-600 mb-1">Description</label>
                    <input type="text" id="transactionDescriptionInput" name="description" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="transactionAmountInput" class="block text-sm font-medium text-slate-600 mb-1">Amount</label>
                    <input type="number" id="transactionAmountInput" name="amount" step="any" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-6">
                    <label for="transactionDateInput" class="block text-sm font-medium text-slate-600 mb-1">Date & Time</label>
                    <input type="datetime-local" id="transactionDateInput" name="date" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                 <div class="flex justify-end gap-3">
                    <button type="button" id="cancelTransactionBtn" class="py-2 px-4 rounded-md text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors">Cancel</button>
                    <button type="submit" id="saveTransactionBtn" class="py-2 px-4 rounded-md bg-sky-500 text-white hover:bg-sky-600 active:bg-sky-700 transition-colors">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Money Tracker App Initialized - V2 Profile Management");

            // --- DOM Elements ---
            const addProfileBtn = document.getElementById('addProfileBtn');
            const profileModal = document.getElementById('profileModal');
            const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const profileForm = document.getElementById('profileForm');
            const profileIdField = document.getElementById('profileIdInput'); // Updated ID
            const profileNameInput = document.getElementById('profileNameInput');
            const profileCurrencySelect = document.getElementById('profileCurrencyInput'); // Updated ID
            const profilesListEl = document.getElementById('profilesList'); // Renamed for clarity
            const currentProfileNameDisplay = document.getElementById('currentProfileName');
            const profileCurrencyDisplay = document.getElementById('profileCurrencyDisplay');

            const addIncomeBtn = document.getElementById('addIncomeBtn');
            const addOutcomeBtn = document.getElementById('addOutcomeBtn');
            const transactionModal = document.getElementById('transactionModal');
            const closeTransactionModalBtn = document.getElementById('closeTransactionModalBtn');
            const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
            const transactionForm = document.getElementById('transactionForm');
            const transactionModalTitle = document.getElementById('transactionModalTitle');
            const transactionIdField = document.getElementById('transactionIdInput'); // Updated ID
            const transactionTypeField = document.getElementById('transactionTypeInput'); // Updated ID
            const transactionDescriptionInput = document.getElementById('transactionDescriptionInput');
            const transactionAmountInput = document.getElementById('transactionAmountInput');
            const transactionDateInput = document.getElementById('transactionDateInput');
            const transactionsListEl = document.getElementById('transactionsList'); // Renamed for clarity
            const noTransactionsMessage = document.getElementById('noTransactionsMessage');

            const totalIncomeDisplay = document.getElementById('totalIncome');
            const totalOutcomeDisplay = document.getElementById('totalOutcome');
            const netBalanceDisplay = document.getElementById('netBalance');
            
            const viewAllProfilesBtn = document.getElementById('viewAllProfilesBtn');
            const appCurrencySelect = document.getElementById('currencySelect'); 

            const importDataBtn = document.getElementById('importDataBtn');
            const importFile = document.getElementById('importFile');
            const exportDataBtn = document.getElementById('exportDataBtn');

            const STORAGE_KEY = 'moneyTrackerData_v1';

            // --- App State ---
            let state = {
                profiles: [], // { id, name, currency, transactions: [] }
                activeProfileId: 'all', // Default to 'all'
                editingProfileId: null,
                editingTransactionId: null,
                // Global app currency setting (can be used for default new profile currency)
                // This is distinct from individual profile currencies.
                globalDefaultCurrency: 'IDR', 
            };

            // --- Utility Functions ---
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            }

            // --- Local Storage ---
            function loadData() {
                console.log("Attempting to load data from localStorage...");
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        // Basic validation of loaded data structure
                        if (parsedData && Array.isArray(parsedData.profiles)) {
                            state.profiles = parsedData.profiles;
                            state.activeProfileId = parsedData.activeProfileId || 'all';
                            state.globalDefaultCurrency = parsedData.globalDefaultCurrency || 'IDR';
                            console.log("Data loaded successfully:", state);
                        } else {
                            console.warn("Loaded data is not in the expected format. Initializing with defaults.");
                            initializeDefaultState();
                        }
                    } catch (error) {
                        console.error("Error parsing data from localStorage:", error);
                        initializeDefaultState(); // Fallback to default state on error
                    }
                } else {
                    console.log("No data found in localStorage. Initializing with defaults.");
                    initializeDefaultState();
                }
                appCurrencySelect.value = state.globalDefaultCurrency; // Sync UI
            }

            function initializeDefaultState() {
                state.profiles = [];
                state.activeProfileId = 'all';
                state.globalDefaultCurrency = 'IDR'; // Default global currency
                // Optionally, create a default "Personal" profile on first load
                // if (state.profiles.length === 0) {
                //     state.profiles.push({ id: generateId(), name: "Personal", currency: "IDR", transactions: [] });
                //     state.activeProfileId = state.profiles[0].id;
                // }
            }

            function saveData() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        profiles: state.profiles,
                        activeProfileId: state.activeProfileId,
                        globalDefaultCurrency: state.globalDefaultCurrency
                    }));
                    console.log("Data saved to localStorage:", state);
                } catch (error) {
                    console.error("Error saving data to localStorage:", error);
                    // Potentially notify user if storage is full or unavailable
                    alert("Error: Could not save data. Your browser's local storage might be full or disabled.");
                }
            }

            // --- Modal Management ---
            function openModal(modalElement) {
                modalElement.style.display = 'flex';
                // Trigger reflow for animation
                modalElement.offsetHeight; 
                modalElement.classList.add('modal-open');
            }

            function closeModal(modalElement) {
                modalElement.style.display = 'none';
                modalElement.classList.remove('modal-open');
            }

            // --- Profile Management ---
            function renderProfiles() {
                console.log("Rendering profiles...");
                profilesListEl.innerHTML = ''; // Clear existing list
                if (state.profiles.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = 'No profiles yet. Add one!';
                    p.className = 'text-sm text-slate-500 px-3 py-2';
                    profilesListEl.appendChild(p);
                } else {
                    state.profiles.forEach(profile => {
                        const profileDiv = document.createElement('div');
                        profileDiv.className = `profile-item p-3 rounded-md cursor-pointer border border-transparent hover:border-sky-300 flex justify-between items-center text-sm`;
                        profileDiv.dataset.profileId = profile.id;

                        const profileNameSpan = document.createElement('span');
                        profileNameSpan.className = 'profile-name font-medium text-slate-700 truncate';
                        profileNameSpan.textContent = profile.name;
                        profileDiv.appendChild(profileNameSpan);
                        
                        // Placeholder for edit/delete icons if needed later
                        // const controlsDiv = document.createElement('div');
                        // controlsDiv.innerHTML = `<svg class="lucide lucide-more-horizontal w-4 h-4 text-slate-400"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>`;
                        // profileDiv.appendChild(controlsDiv);


                        if (profile.id === state.activeProfileId) {
                            profileDiv.classList.add('active');
                        }

                        profileDiv.addEventListener('click', () => {
                            state.activeProfileId = profile.id;
                            saveData();
                            renderProfiles(); // Re-render to update active class
                            renderDashboard();
                        });
                        profilesListEl.appendChild(profileDiv);
                    });
                }
                // Ensure Lucide icons are processed if dynamically added (not strictly needed for current profile items)
                // if (typeof lucide !== 'undefined' && lucide.createIcons) {
                //    lucide.createIcons();
                // }
                console.log("Profiles rendered. Active ID:", state.activeProfileId);
            }

            function handleProfileFormSubmit(event) {
                event.preventDefault();
                const name = profileNameInput.value.trim();
                const currency = profileCurrencySelect.value;

                if (!name) {
                    alert("Profile name cannot be empty."); // Replace with better UI feedback later
                    return;
                }

                if (state.editingProfileId) { // Editing existing profile
                    const profile = state.profiles.find(p => p.id === state.editingProfileId);
                    if (profile) {
                        profile.name = name;
                        profile.currency = currency;
                        console.log("Profile updated:", profile);
                    }
                } else { // Adding new profile
                    const newProfile = {
                        id: generateId(),
                        name: name,
                        currency: currency,
                        transactions: []
                    };
                    state.profiles.push(newProfile);
                    state.activeProfileId = newProfile.id; // Set new profile as active
                    console.log("New profile added:", newProfile);
                }
                
                state.editingProfileId = null; // Reset editing ID
                saveData();
                renderProfiles();
                renderDashboard(); // Update dashboard with new/active profile
                closeModal(profileModal);
                profileForm.reset();
            }

            addProfileBtn.addEventListener('click', () => {
                state.editingProfileId = null;
                document.getElementById('profileModalTitle').textContent = 'Add New Profile';
                profileForm.reset();
                profileIdField.value = ''; // Clear hidden ID field
                profileCurrencySelect.value = state.globalDefaultCurrency; // Use global default
                openModal(profileModal);
                profileNameInput.focus();
            });
            
            viewAllProfilesBtn.addEventListener('click', () => {
                state.activeProfileId = 'all';
                saveData();
                renderProfiles();
                renderDashboard();
                console.log("Viewing all profiles.");
            });

            // --- Transaction Management (Placeholders/Basic Setup) ---
            function openTransactionModal(type) {
                if (!state.activeProfileId || state.activeProfileId === 'all') {
                    // Consider a more user-friendly notification
                    alert("Please select a specific profile to add transactions.");
                    return;
                }
                const currentProfile = state.profiles.find(p => p.id === state.activeProfileId);
                if (!currentProfile) {
                     alert("Error: Active profile not found.");
                     return;
                }

                state.editingTransactionId = null;
                transactionForm.reset();
                transactionModalTitle.textContent = type === 'income' ? `Add Income (${currentProfile.currency})` : `Add Outcome (${currentProfile.currency})`;
                transactionTypeField.value = type;
                
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); 
                transactionDateInput.value = now.toISOString().slice(0,16);
                
                // Set amount placeholder or currency symbol if desired
                transactionAmountInput.placeholder = `Amount in ${currentProfile.currency}`;

                openModal(transactionModal);
                transactionDescriptionInput.focus();
            }

            function handleTransactionFormSubmit(event) {
                event.preventDefault();
                console.log("Transaction form submitted (logic to be implemented)");
                // Detailed implementation in next part
                closeModal(transactionModal);
            }
            
            // --- Dashboard Rendering ---
            function renderDashboard() {
                console.log("Rendering dashboard for profile ID:", state.activeProfileId);
                let currentCurrency = state.globalDefaultCurrency; // Default for 'all' or if profile not found

                if (state.activeProfileId === 'all') {
                    currentProfileNameDisplay.textContent = 'Dashboard - All Profiles';
                    profileCurrencyDisplay.textContent = `Summary across all profiles. Default currency: ${state.globalDefaultCurrency}`;
                    // Aggregation logic for 'all' profiles will go here
                } else {
                    const profile = state.profiles.find(p => p.id === state.activeProfileId);
                    if (profile) {
                        currentProfileNameDisplay.textContent = `Dashboard - ${profile.name}`;
                        profileCurrencyDisplay.textContent = `Currency: ${profile.currency}`;
                        currentCurrency = profile.currency;
                    } else {
                        currentProfileNameDisplay.textContent = 'Dashboard - Profile Not Found';
                        profileCurrencyDisplay.textContent = 'Please select a valid profile.';
                        state.activeProfileId = 'all'; // Fallback
                        renderProfiles(); // Re-render profiles to correct selection
                    }
                }
                // Update summary cards (placeholder values for now)
                // Actual calculation will depend on transactions and selected currency formatting
                totalIncomeDisplay.textContent = formatCurrency(0, currentCurrency);
                totalOutcomeDisplay.textContent = formatCurrency(0, currentCurrency);
                netBalanceDisplay.textContent = formatCurrency(0, currentCurrency);

                renderTransactions(); // Will be implemented next
                console.log("Dashboard rendered.");
            }

            function renderTransactions() {
                console.log("Rendering transactions (placeholder)...");
                // transactionsListEl.innerHTML = ''; // Clear
                // For now, keep static examples or show "No transactions"
                // Logic to filter and display transactions for the activeProfileId will go here.
                 const hasTransactions = false; // Placeholder
                 noTransactionsMessage.style.display = hasTransactions ? 'none' : 'block';

                 if (state.activeProfileId && state.activeProfileId !== 'all') {
                    const profile = state.profiles.find(p => p.id === state.activeProfileId);
                    if (profile && profile.transactions && profile.transactions.length > 0) {
                        // Show transactions
                    } else {
                        noTransactionsMessage.textContent = "No transactions yet for this profile.";
                    }
                 } else if (state.activeProfileId === 'all') {
                     noTransactionsMessage.textContent = "Aggregated transaction view coming soon.";
                 } else {
                     noTransactionsMessage.textContent = "Select a profile to see transactions.";
                 }

            }

            // --- Currency Formatting (Basic) ---
            function formatCurrency(amount, currencyCode) {
                // Basic formatter, can be expanded with Intl.NumberFormat for better localization
                const symbols = { IDR: 'Rp', USD: '$', JPY: '¥', EUR: '€', SGD: 'S$' };
                const symbol = symbols[currencyCode] || currencyCode; // Fallback to code if symbol unknown
                return `${symbol}${parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
            }

            // --- Event Listeners (Modals, Forms, Settings) ---
            // Profile Modal
            closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
            cancelProfileBtn.addEventListener('click', () => closeModal(profileModal));
            profileForm.addEventListener('submit', handleProfileFormSubmit);

            // Transaction Modal
            closeTransactionModalBtn.addEventListener('click', () => closeModal(transactionModal));
            cancelTransactionBtn.addEventListener('click', () => closeModal(transactionModal));
            addIncomeBtn.addEventListener('click', () => openTransactionModal('income'));
            addOutcomeBtn.addEventListener('click', () => openTransactionModal('outcome'));
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);

            // Close modals on outside click
            window.addEventListener('click', (event) => {
                if (event.target === profileModal) closeModal(profileModal);
                if (event.target === transactionModal) closeModal(transactionModal);
            });
            // Close modals on Escape key
            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (profileModal.style.display === 'flex') closeModal(profileModal);
                    if (transactionModal.style.display === 'flex') closeModal(transactionModal);
                }
            });

            // App Settings
            appCurrencySelect.addEventListener('change', (e) => {
                state.globalDefaultCurrency = e.target.value;
                saveData();
                // Optionally, update dashboard if 'all' profiles view is active and uses global default
                if (state.activeProfileId === 'all') {
                    renderDashboard();
                }
                console.log('Global default currency changed to:', state.globalDefaultCurrency);
            });
            
            // Import/Export (Placeholders)
            importDataBtn.addEventListener('click', () => {
                console.log('Import Data clicked');
                importFile.click(); 
            });
            importFile.addEventListener('change', (event) => {
                console.log('File selected for import:', event.target.files[0]);
                // Actual import logic will be here in a future part
            });
            exportDataBtn.addEventListener('click', () => console.log('Export Data clicked - logic TBD'));

            // --- Initial Load & Render ---
            loadData();
            renderProfiles();
            renderDashboard();

            console.log("Initial script setup complete. Profile management is active.");
        });
    </script>
</body>
</html>
